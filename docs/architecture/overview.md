# Architecture Overview — Robo Racer

## 目的 / Why this exists
このリポジトリは、**小型自動運転カーを「安全に・早く・再現性高く」走らせる**ための
フルスタック構成です。単なるデモではなく、次の3点を満たすことを狙います。

1. **低遅延で安全**: 走行の最終制御はESP32が担当し、緊急停止を最優先にする。
2. **責務配置の柔軟性**: 走行戦略や認識を、ESP32/RPiのどちらでも試せる構造にする。
3. **学習パイプラインの再現性**: 学習→モデル管理→実機投入の流れを一本化する。

---

## 設計の前提: 固定責務と可変責務

本プロジェクトは「**責務を試行錯誤しやすい構成**」を重視します。ただし、**物理走行と安全**
に関わる責務は固定します。

### 固定される責務（物理走行・安全）

この範囲は設計実験の対象外で、**配線や安全要件が変わらない限り固定**とします。

- **ESP32の固定責務**
  - **サーボ/モータの最終出力**（走行の最終責任）
  - **IMUの送受信**（IMUの取得・ホストへの送信）
  - **緊急停止（E-Stop）と安全クランプ**
  - ホスト監視・リアルタイム制御ループの維持
- **RPiの固定責務**
  - **2D LiDARの取得と送受信**（2D LiDARはRPiで扱い、必要な情報をESP32に送る）
- **RPi ↔ ESP32の堅牢通信**
  - 低遅延・エラー検出が可能なバイナリ通信を維持する

### 可変な責務（試行領域）

以下は **ESP32でもRPiでも自由に配置を試せる**領域です。

- 走行戦略（Cruise / Brake / 回避 / 追従など）
- 経路計画・速度プロファイル
- 障害物認識・地物推定
- モデル推論・学習済みモデルの適用
- ルールベース vs 学習ベースの比較

---

## 構成イメージ（固定と可変の分離）

```
2D LiDAR (fixed) -> RPi (I/O + optional perception)
                         |
                  COBS + CRC16 (UART)
                         |
ESP32 (fixed): Motor/Servo, IMU I/O, E-Stop
ESP32 (optional): strategy/control if試したい場合
```

---

## 配置パターンの例（いずれも許容）

- **RPi主導**: RPiで認識/戦略を実装し、操舵/速度目標をESP32へ送信
- **ESP32主導**: ESP32側で戦略まで完結し、RPiはログ/可視化のみ
- **ハイブリッド**: RPiで高レベル意思決定、ESP32で低遅延の局所回避

どのパターンでも、**固定責務は必ず維持**します。

---

## 通信インターフェース（RPi ↔ ESP32）

- **物理層**: UART
- **フレーミング**: COBS
- **検査**: CRC16-CCITT
- **最低限のメッセージ**
  - `SetMode` / `SetManual` / `SetPrefer`
  - `Estop` / `ClearEstop`
  - `Status`（姿勢・出力・状態）

**設計意図**: アルゴリズム配置の変更に耐えるよう、基礎メッセージは保ちつつ拡張可能にする。

---

## 現状の実装（参考）

### RPiランタイム（Python, src/）

- **perception/**: カメラ/2D LiDAR入力、推論、地物推定（現在は雛形）
- **control/**: 走行戦術/速度目標（実験領域）
- **driver/**: ESP32との通信ドライバ
- **common/**: 型定義・共有ユーティリティ

### ESP32ファームウェア（firmware/）

- **app/App**: ループ統括（センサ → コマンド → 状態遷移 → 出力 → テレメトリ）
- **control/**: 走行制御・状態機械（戦略は可変領域として扱う）
- **hardware/**: IMU、モータ、サーボ、その他接続センサ
- **comm/**: COBS + CRC16のプロトコル

---

## 安全設計（固定ルール）

- **E-Stopは常に最優先**（即座にスロットル0、操舵センター）
- **安全クランプの維持**（距離・姿勢などの安全条件）
- **ホスト監視**（通信途絶時は安全停止）

---

## 学習・モデル運用（想定）

```
training/data -> training/src -> models/production -> 推論（RPi or ESP32）
```

- 学習モデルの配置場所と更新フローは維持する
- 推論実行場所は **可変領域** として扱う

---

## 既知の未実装 / 今後の埋めどころ

- RPi側の通信実装（Protocol.h準拠の送受信）
- perception/control の具体ロジック
- training パイプラインの実装とデータ仕様
- config/ の実データ化（車体パラメータ、学習ハイパーパラメータ）
